<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Vector Tile</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js"></script>
<link href='style.css' rel='stylesheet' />
</head>
<body>
<div id="map"></div>
<input
    id="gene-select"
    class="map-overlay"
    type="text"
    value="Tgoln1"
/>
<script>

mapboxgl.accessToken = 'pk.eyJ1IjoiYWhnbm95IiwiYSI6ImZIcGRiZjgifQ.pL1SaB8gHyl-L2yolSl5Qw';
const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v10',
    zoom: 12,
    center: [0.28658, 0.1119]
});
const filterInput = document.getElementById('gene-select');
map.on('load', () => {
    map.addSource('liver', {
        'type': 'vector',
        'tiles': [
            'https://seqscope.s3.us-east-2.amazonaws.com/liver1m/{z}/{x}/{y}.pbf'
        ],
        'minzoom': 3,
        'maxzoom': 14
    });
    map.addLayer({
        'id': 'liver-gene',
        'type': 'circle',
        'source': 'liver',
        'source-layer': 'liver',
        'paint': {
            'circle-radius': 8,
            'circle-color': '#A2F',
            'circle-opacity': 0.8
        }
    });
    map.setFilter('liver-gene', ['==', ['get', 'short_name'], 'Tgoln1']);
    map.addLayer({
        'id': 'liver-viz',
        'type': 'circle',
        'source': 'liver',
        'source-layer': 'liver',
        'paint': {
            'circle-radius':["interpolate",["exponential", 2], ["zoom"], 6, 1, 15, 8],
            'circle-color': {
                'property': 'cnt_unspliced',
                'stops': [
                    [0, '#777'],
                    [1, '#FB1']
                ]
            },
            'circle-opacity': 0.3
        }
    });
});
map.on('click', 'liver-viz', function (e) {
    var feature = e.features[0];
    var coordinates = feature.geometry.coordinates.slice();
    var properties = Object.keys(feature.properties).map(function (propertyName) {
        return renderProperty(propertyName, feature.properties[propertyName]);
    });
    console.log(coordinates);
    new mapboxgl.Popup()
        .setLngLat(coordinates)
        .setHTML(properties.join(' '))
        .addTo(map);
    });
map.on('click', 'liver-gene', function (e) {
    var feature = e.features[0];
    var coordinates = feature.geometry.coordinates.slice();
    var properties = Object.keys(feature.properties).map(function (propertyName) {
        return renderProperty(propertyName, feature.properties[propertyName]);
    });
    console.log(coordinates);
    new mapboxgl.Popup()
        .setLngLat(coordinates)
        .setHTML(properties.join(' '))
        .addTo(map);
    });

filterInput.addEventListener('keyup', (e) => {
    const value = e.target.value;
    map.setFilter('liver-gene', ['==', ['get', 'short_name'], value]);
});
    
function renderProperty(propertyName, property) {
  return '<div class="mbview_property">' +
    '<div class="mbview_property-name">' + propertyName + '</div>' +
    '<div class="mbview_property-value">' + displayValue(property) + '</div>' +
    '</div>';
}
function displayValue(value) {
  if (typeof value === 'undefined' || value === null) return value;
  if (typeof value === 'number') return Math.round(value).toString();
  if (typeof value === 'object' ||
      typeof value === 'string') return value.toString();
  return value;
}
</script>

</body>
</html>